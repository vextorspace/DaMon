var vwConfig={helpTexts:[{id:"sensorInfo",text:"<p>Valley Water operates different types of sensors to collect surface water data. Here you can toggle between the three main types of sensors: stream, reservoir, and rain. Rain sensors operate by measuring accumulated rainfall through the use of small tipping buckets. For rainfall data, YTD implies the water year from October through September of the following year. Errors can be introduced when there is heavy wind or debris blocking the collector. The stream and reservoir sensors directly measure water level, while both flow and storage are inferred through field measurements and bathymetric surveys, which can introduce some error. Typically, storage errors are small, while flow errors are larger. More information about stream gaging can be found on the <a href = 'https://www.usgs.gov/faqs/what-a-rating-curve-why-does-it-change-over-time?'>USGS Website<\/a>.<\/p><p>Data are reviewed and quality controlled by staff during the summer for the previous year. Much of the recent data are raw and may include transmission or instrument malfunction. Data gaps and errors exist in the dataset and users should exercise caution. This site displays available data for active sensors. To seek all available data, please contact our public records request.<\/p>"},{id:"thresholdsInfo",text:"<p>The Flood Watch toggle will only display the sensors that have a threshold or forecast.<\/p><p>Thresholds indicate locations where there are known and estimated flood risks. The severity of the current and future forecast for the location is indicated by the color coding. Thresholds were developed using the best available information at the time and are subject to inaccuracies. Stream forecasts are available in select locations and are based on future weather conditions. Forecasts may be highly variable and should be used with caution.<\/p><p>Valley Water operates a forecasting tool to estimate future water levels. These predictions are heavily influenced by rain forecasts provided by third parties and are subject to uncertainty. Please use the data provided with caution, as its purpose is to provide an additional layer of data to inform decisions. We are continuously working to improve the accuracy of predictions and adding new forecast locations. Additional forecasts for our river systems are done by the <a href='https://www.cnrfc.noaa.gov/rfc_guidance.php'>California Nevada River Forecast Center<\/a>.<p> Notifications are still being developed and will be available in a later update to the website.<\/p>"},{id:"disclaimerInfo",text:"<p>Some data from this website is preliminary and should be used with discretion. Valley Water does not make any guarantee, implicit or explicit, on the accuracy of the information. <\/p>"}],tour:{start:{},steps:[{modalId:"#tourModal1",background:"#tour-background"},{elementSelector:"#mapDiv",title:"Zoom in",content:"<p>Zoom in closer to see current sensor readings. They look like this:<\/p><p><img src='images/tour/sensor.jpg' title='Sensor Example' class='sensorExample' /><\/p>",placement:"left",background:".tour-backdrop",addClasses:[["body","tour-on"],["#mapTourBackground","minOpacity"]]},{elementSelector:".container-sensors",title:"Show and Search Sensors",content:" <p>Toggle between different types of data, and search for sensors.<\/p>",placement:"top",background:".tour-backdrop",addClasses:[["body","tour-on"],[".container-search","tour-show"],[".hr-search","tour-show"],[".container-sensors","tour-show"],[".search-icon","tour-show"]],adjustMobilePosition:{placement:"top",transformX:100,transformY:296}},{elementSelector:".thresholds",title:"Flood Watch",content:"<p>Look for the flood watch toggle, which shows available flood watch thresholds on the map and in graph views.<\/p>",placement:"top",background:".tour-backdrop",addClasses:[["body","tour-on"],[".thresholds","tour-show"]],adjustMobilePosition:{placement:"top",transformX:100,transformY:398}},{elementSelector:".container-api",title:"Download Data",content:"<p>Click here to download lots of data or use our API.<\/p>",placement:"top",background:".tour-backdrop",addClasses:[["body","tour-on"],[".container-api","tour-show"]]},{elementSelector:".toggle-pages",title:"Table View",content:"<p>Change to List view to see and sort all current sensor statuses and readings at a glance.<\/p>",placement:"top",background:".tour-backdrop",addClasses:[["body","tour-on"],[".toggle-pages","tour-show"]]},{elementSelector:".map .tour-backdrop",title:"Sensor Details",content:"<p><img src='images/tour/graph.jpg' title='Sensor Details Example' style='width: 100%; height: auto; max-width: 250px' /><\/p><p>Click on a sensor to see details. This is where you can find and export in-depth data from individual sensors.<\/p>",placement:"bottom",background:".tour-backdrop",addClasses:[["body","tour-on"],[".map .tour-backdrop","sensor-details"]]}]},thresholdLevels:[{value:"th1_direct",rating:"th1_rated",desc:"threshold1Desc",color:"yellow",graphColor:"rgba(255,255,0,0.2)",text:"Action"},{value:"th2_direct",rating:"th2_rated",desc:"threshold2Desc",color:"orange",graphColor:"rgba(255,165,0,0.2)",text:"Minor Flooding"},{value:"th3_direct",rating:"th3_rated",desc:"threshold3Desc",color:"red",graphColor:"rgba(255,0,0,0.2)",text:"Moderate Flooding"},{value:"th4_direct",rating:"th4_rated",desc:"threshold4Desc",color:"purple",graphColor:"rgba(75,0,130,0.2)",text:"Major Flooding"}],geoJsonLayers:[{title:"Watersheds",filename:"majorwatersheds.geojson",name:"majorwatersheds",type:"polygon",style:{stroke:!0,color:"#555555",weight:2,fill:!0,fillOpacity:.05,fillColor:"#ffffff"},tooltipClass:"watersheds"}],camerasLayer:{dataUrl:"cameras/all",symbol:{iconUrl:"images/camera-fill-round.svg",iconSize:[26,26]},webcamsUrl:"https://valleywateralert.org/scvwd/webcams/site.php?cid="}};"use strict";const valleyWaterMain={_targetWidth:768,_popupOffsetPixels:-28,_timezone:"America/Los_Angeles",_minDate:"2000-01-01",_resizeTimer:null,_sensors:null,_sensorListIdPrefix:"listSensor_",_sortSensorsBy:"type",_sortSensorsAsc:!1,_updateTimer:null,_lastUpdate:null,_disclaimer:null,init:function(){valleyWaterMain.initUi();valleyWaterMap.init();valleyWaterSensor.init();valleyWaterMain._getSensors();valleyWaterMain._updateTimer=setInterval(valleyWaterMain._getSensors,valleyWaterSettings.RefreshInterval*1e3);const n=$("#refreshBtn");n.length>0&&n.click(valleyWaterMain._getSensors)},initUi:function(){function i(n){$(".list-container").toggleClass("mobile-sidebar-open");const t=$(".mobile-sidebar");t.animate({bottom:n?"0px":"-365px"},200);t.toggleClass("up");$(".mobile-sidebar-closed").toggleClass("up");$(".map").toggleClass("noSidebar")}function r(n){const t=$("#layerModal"),i=$(".layer-sidebar"),r=valleyWaterMain.isMobileWidth();n=n||t.is(":visible")||!i.hasClass("closed");n?r?i.addClass("closed"):t.fadeOut("fast"):r?i.removeClass("closed"):t.fadeIn("fast");$(".map-layer-btn").toggleClass("active")}const t=valleyWaterMain;$(".sensor-checkbox input").click(this.sensorCheckboxChecked);$(".sensor-toggle .btn").click(this.sensorToggleClicked);$(".sensorListSort").click(this.sensorListSortClicked);$("[data-toggle='tooltip']").tooltip();$(".threshold-toggle").bootstrapToggle();$("#pageButtons > button").click(function(){const n=$(this).text()==="Map"?"map":"list";valleyWaterMain.setMapListView(n)});const n=this._getQuery();n.p&&n.p!=="map"?n.p==="list"?t.setMapListView("list",!0):n.p==="sensor"&&t.switchMainSensorPanels(!0):history.replaceState({panel:"map"},"Surface Water Data Portal - Map","?p=map");window.onpopstate=this.backOrForwardClicked;isDst&&$("#dstNote").show();n.disc&&n.disc==="f"||$("#disclaimerModal").modal("show");$(".list-table").on("click",".sensorListRow td",function(n){if(!$(this).hasClass("sensorCbxCell")&&!$(n.target).hasClass("mobileDetailsToggle")){const n=$(this).parent().data("sid");valleyWaterSensor.showSensorPanel(n,!1)}});$(".list-table").on("click",".mobileDetailsToggle",function(){$(this).toggleClass("fa-sort-down").toggleClass("fa-sort-up")});$(".list-table").on("click",".sensorListCbx",this.sensorListCheckboxClicked);$("#compareSensorsBtn").click(this.compareSensorsClicked);$(".floodwatch-toggle").bootstrapToggle();$(".floodwatch-toggle").change(this.floodwatchToggleChanged);$(".open-toggle").click(function(){$(this).toggleClass("collapsed")});$(".map-layer-btn").click(function(){r()});$(".layerDialog .close").click(function(){r(!0)});$(".sidebar-toggle .fas").on("click",function(){$(".list-container").toggleClass("sidebar-open");$(".desktop-sidebar").toggleClass("closed");$(".sidebar-toggle .fas").toggleClass("active");const n=$(".sidebar-toggle .fas").hasClass("active")?500:1;setTimeout(function(){const n=$("#mapPanel");n.toggleClass("full-width");valleyWaterMap.resizeMap()},n)});$(".mobile-sidebar").swipe({swipeDown:function(){i(!1)},threshold:20,allowPageScroll:"none"});$(".mobile-sidebar-closed").swipe({swipeUp:function(){i(!0)},threshold:0});$("#mobileSidebarHandle").click(function(){i(!1)});$(".mobile-sidebar-closed").click(function(){i(!0)});$(window).resize(t.windowResized);$(".lnkDisclaimer").on("click",function(n){n.preventDefault();$("#disclaimerModal").modal("show")});$.each(vwConfig.helpTexts,function(n,t){$("#"+t.id).html(t.text)});t._initTour()},setMapListView:function(n,t){const i=$("#mapPanel"),r=$("#listPanel");n==="list"?(i.css("visibility","hidden"),r.show()):t||(i.css("visibility","visible"),r.hide());$("#pageButtons > button").each(function(){const t=$(this);t.text().toLowerCase()===n?t.addClass("active"):t.removeClass("active")});t||this.setBrowserHistory("?p="+n,{panel:n},"Surface Water Data Portal - "+n)},setBrowserHistory:function(n,t,i){n=location.pathname+n;location.search.indexOf("disc=f")&&(n+="&disc=f");history.pushState(t,i,n)},backOrForwardClicked:function(n){if(n.state)switch(n.state.panel){case"map":valleyWaterMain.switchMainSensorPanels(!1,!0);break;case"list":valleyWaterMain.switchMainSensorPanels(!1,!1);break;case"sensor":valleyWaterSensor.showSensorPanel(n.state.sid,!0)}},switchMainSensorPanels:function(n,t){const i=n?"none":"block";$(".sidebar").css("display",i);$(".layer-sidebar").css("display",i);$("#sensorPanel").css("display",n?"block":"none");n?($("#listPanel").hide(),$("#mapPanel").css("visibility","hidden"),$("#pageButtons").hide(),$("#refreshBtn").hide(),$(".sidebar-toggle").css("visibility","hidden"),$(".updateTimestamp").css("visibility","hidden")):($("#pageButtons").show(),$("#refreshBtn").show(),$(".sidebar-toggle").css("visibility","visible"),$(".updateTimestamp").css("visibility","visible"),valleyWaterMain.setMapListView(t?"map":"list"));$(".modal").each(function(){this.id!=="disclaimerModal"&&$(this).modal("hide")})},sensorCheckboxChecked:function(){let t="Desktop",n=this.id.indexOf("Mobile");n<0&&(t="Mobile",n=this.id.indexOf("Desktop"));const i=this.id.substring(0,n)+t;$("#"+i).prop("checked",$(this).is(":checked"));valleyWaterMain._showSensors(!1)},sensorToggleClicked:function(){const r=$(this).data("unit");let i="sensorToggleStream",t="stream",n;switch(r){case"streamFlow":n="flow";break;case"streamStage":n="stage";break;case"reservoirStorage":i="sensorToggleReservoir";t="reservoir";n="storage";break;case"reservoirStage":i="sensorToggleReservoir";t="reservoir";n="stage";break;case"rainfallYtd":i="sensorToggleRainfall";t="rainfall";n="ytd";break;case"rainfall24Hour":i="sensorToggleRainfall";t="rainfall";n="24hr";break;case"rainfall12Hour":i="sensorToggleRainfall";t="rainfall";n="12hr";break;case"rainfall6Hour":i="sensorToggleRainfall";t="rainfall";n="6hr";break;case"rainfall3Hour":i="sensorToggleRainfall";t="rainfall";n="3hr";break;case"rainfall1Hour":i="sensorToggleRainfall";t="rainfall";n="1hr"}const u=$("."+i+" .btn");u.removeClass("active");$(this).addClass("active");const f=".sensor-popup-"+t,e=".sensor-popup-"+t+"-"+n;$(f).hide();$(e).show()},_getSensors:function(){function n(n){if(n)for(let t,i=-1;t=n[++i];){let n=t.timestamp;n!==null?(n.indexOf("-",12)<0&&(n+="Z"),t.timestampDate=new Date(n)):t.timestampDate=null}}$(".updateTimestamp").text("Refreshing data...");$.getJSON(valleyWaterSettings.ValleyWaterApiUrl+"/sensor/current",function(t){$("#mapDataLoadingImg").hide();const i=valleyWaterMain;if(t.precipitation&&t.precipitation.length>0){n(t.precipitation);n(t.reservoirs);n(t.streams);const r=i._sensors===null;if(i._sensors=t,i._showSensors(!0),i._lastUpdate=new Date,i._updateTimestampDisplay(!0),r){const n=i._getQuery();if(n.p==="sensor"&&n.sid){const t=Number(n.sid);isNaN(t)||valleyWaterSensor.showSensorPanel(t,!0)}i._setupSearch()}}else console.log("Sensor response",t),i._updateTimestampDisplay(!1)}).fail(function(n,t,i){$("#mapDataLoadingImg").hide();console.log("Error getting data",i);console.log(n);valleyWaterMain._updateTimestampDisplay(!1)})},_setupSearch:function(){function t(n,t){for(let i=0;i<n.length;i++){const r=n[i];t.push({label:r.name+" ("+r.gageId+")",value:r.name+"|"+r.gageId,sensorId:r.gageId})}}const n=[];t(this._sensors.reservoirs,n);t(this._sensors.streams,n);t(this._sensors.precipitation,n);$(".searchInput").tierraplanAutocomplete({source:n,focus:function(){return!1},select:function(n,t){return $(n.target).val(""),valleyWaterSensor.showSensorPanel(t.item.sensorId,!1),!1}})},getSensorLayerVisibilities:function(){return{streamsOn:$("#streamsCbxMobile").prop("checked"),precipitationOn:$("#rainfallCbxMobile").prop("checked"),reservoirsOn:$("#reservoirsCbxMobile").prop("checked")}},_showSensors:function(n){function e(n,r,f,e){function o(n,t){let i="";for(let r=0;r<n.length;r++){const u=n[r];i+=t?"<div class='row'><div class='col-6'>"+u.label+"<\/div><div class='col-6'>"+u.text+"<\/div><\/div>":"<td class='mobile-hide'>"+u.text+"<\/td>"}return i}for(let s,h=-1;s=n[++h];)if(!f||s.isFloodwatch){const n=t.getSensorDisplayInfo(s);let h=!1;switch(s.gageType){case"StreamStageDischarge":h=i.streamsOn;break;case"StreamStageOnly":h=i.streamsOn;break;case"Precipitation":h=i.precipitationOn;break;case"Reservoir":h=i.reservoirsOn}if(n.gageType){let f=w(s),l=f,a="";f&&f!=="gray"&&(l+=" grow",a=" - ALARM");const v=n.gageType+" "+s.gageId+": "+s.name+a;let i="<svg width='40px' height='40px' viewBox='0 0 40 40' version='1.1' xmlns = 'http://www.w3.org/2000/svg' xmlns: xlink = 'http://www.w3.org/1999/xlink' > <title>"+v+"<\/title><desc>"+n.gageType+": ID "+s.gageId+"<\/desc><g stroke='none' stroke-width='1' fill='none'><g id='"+s.gageId+"' transform='translate(10.000000, 10.000000)'><circle class='center-circle' cx='17.5' cy='17.5' r='7.0'><\/circle>";if(f&&(i+="<circle class='outer-circle1-thin "+l+"' cx='17.5' cy='17.5' r='11'><\/circle><circle class='outer-circle2-thin "+l+"' cx='17.5' cy='17.5' r='15'><\/circle>"),s.hasForecast&&(i+="<circle class='f-circle gray' cx='8' cy='8' r='8'><\/circle><polygon class='f-letter' points='10.2773438 8.20410156 7.46484375 8.20410156 7.46484375 11.109375 6 11.109375 6 4 10.6289062 4 10.6289062 5.18652344 7.46484375 5.18652344 7.46484375 7.02246094 10.2773438 7.02246094'><\/polygon>"),i+="<\/g><\/g><\/svg>",e&&valleyWaterMap.addSensor(s,i,v,t._popupOffsetPixels),h){const f=s.gageId;let e="N/A";if(s.timestampDate){let n="";const i=t._getPacificDate(s.timestampDate);s.timestampDate<u&&(n=s.timestampDate<c?i.date:"Yesterday");e=n+" "+i.time}const h="<tr data-sid='"+f+"' class='sensorListRow' title='Go to page for this sensor'><td class='text-center'><div class='sensor-pin "+n.gageType.toLowerCase()+"'>"+i+"<\/div><\/td><td class='mobile-hide'>"+f+"<\/td><td><div class='sensorNameCell'>"+s.name+"<\/div><i class='fas fa-sort-down desktop-hide collapse-open mobileDetailsToggle' data-toggle='collapse' data-target='#sensor-collapse-"+f+"' aria-expanded='false' aria-controls='sensor-toggle-"+f+"' title='Expand/collapse this sensor'><\/i><div class='collapse desktop-hide sensor-collapse' id='sensor-collapse-"+f+"'><div class='container'><div class='row'><div class='col-6'>Number<\/div><div class='col-6'>"+f+"<\/div><\/div><div class='row'><div class='col-6'>Watershed<\/div><div class='col-6'>"+s.watershed+"<\/div><\/div><div class='row'><div class='col-6'>Updated (PST)<\/div><div class='col-6'>"+e+"<\/div><\/div>"+o(n.displayValues,!0)+"<\/div><\/div><\/td><td><div class='mobile-hide sensorWatershedCell'>"+s.watershed+"<\/div><\/td><td class='mobile-hide'>"+e+"<\/td>"+o(n.displayValues,!1)+"<\/tr>";r.push(h)}}}}function w(n){let i=null,r=vwConfig.thresholdLevels;if(n.gageType!=="Precipitation"&&(n[r[0].value]>0||n[r[0].rating]>0)){if(!t._isStale(n)){const u=t.getSensorValues(n);for(let t=r.length-1;t>=0;t--){const f=r[t];if(n[f.value]>0&&u.value>n[f.value]||n[f.rating]>0&&u.rating>n[f.rating]){i=f.color;break}}}i||(i="gray")}return i}const t=valleyWaterMain,i=t.getSensorLayerVisibilities(),o=[],s=[],h=[],r=$(".floodwatch-toggle").first().is(":checked"),u=t._getPacificDateStart(new Date),c=new Date(u);c.setDate(u.getDate()-1);n&&valleyWaterMap.clearSensors();valleyWaterMap.updateSensorVisibilities(i);valleyWaterMap.saveExtent();e(t._sensors.precipitation,h,r,n);e(t._sensors.reservoirs,s,r,n);e(t._sensors.streams,o,r,n);const f=$("#jumpToLabel"),l=$("#reservoirListLink"),a=$("#rainListLink"),v=$("#backToTopFromReservoirs"),y=$("#backToTopFromRain"),p=$("#noRainWithFloodwatch");f.hide();l.hide();a.hide();v.hide();y.hide();p.hide();i.streamsOn?($("#streamSensorsTable > tbody").html(o.join("")),$("#streamSensorsTable").css("display","table")):$("#streamSensorsTable").css("display","none");i.reservoirsOn?($("#reservoirSensorsTable > tbody").html(s.join("")),$("#reservoirSensorsTable").css("display","table"),i.streamsOn&&(f.show(),l.show(),v.show())):$("#reservoirSensorsTable").css("display","none");i.precipitationOn?($("#rainSensorsTable > tbody").html(h.join("")),$("#rainSensorsTable").css("display","table"),(i.streamsOn||i.reservoirsOn)&&(f.show(),a.show(),y.show()),r&&p.show()):$("#rainSensorsTable").css("display","none");valleyWaterMap.resetExtent();t.resetPopupsOffset()},getSensorValues:function(n){let t={};switch(n.gageType){case"Precipitation":t.hr1=n.precip1Hr;t.hr2=n.precip3Hr;t.hr6=n.precip6Hr;t.hr12=n.precip12Hr;t.hr24=n.precip24Hr;t.ytd=n.precipYtd;break;case"Reservoir":t.value=n.stage;t.rating=n.storage;break;case"StreamStageDischarge":t.value=n.stage;t.rating=n.flow;break;case"StreamStageOnly":t.value=n.stage;t.rating=0}return t},getSensorDisplayInfo:function(n){function i(n,i,r,u){return n!==null&&n>=0&&!t._isStale(i)?t.roundValue(n,u||0)+" "+r:"N/A"}const s=L.latLng(n.latitude,n.longitude),o=valleyWaterMap._layers,t=valleyWaterMain;let u,r,f,e=[];switch(n.gageType){case"Precipitation":u="Rainfall";f=o.precipitation;r="in";e=[{key:"1hr",label:"1 hr",value:t.roundValue(n.precip1Hr),text:i(n.precip1Hr,n,r,2)},{key:"3hr",label:"3 hr",value:t.roundValue(n.precip3Hr),text:i(n.precip3Hr,n,r,2)},{key:"6hr",label:"6 hr",value:t.roundValue(n.precip6Hr),text:i(n.precip6Hr,n,r,2)},{key:"12hr",label:"12 hr",value:t.roundValue(n.precip12Hr),text:i(n.precip12Hr,n,r,2)},{key:"24hr",label:"24 hr",value:t.roundValue(n.precip24Hr),text:i(n.precip24Hr,n,r,2)},{key:"ytd",label:"YTD",value:t.roundValue(n.precipYtd),text:i(n.precipYtd,n,r,2)}];break;case"Reservoir":u="Reservoir";f=o.reservoirs;let s,h;n.storage>=0&&n.th1_rated>0?(s=t.roundValue(n.storage/n.th1_rated*100),h=s+"%"):(s=0,h="N/A");e=[{key:"stage",label:"Stage",value:t.roundValue(n.stage),text:i(n.stage,n,"ft")},{key:"storage",label:"Storage",value:t.roundValue(n.storage),text:i(n.storage,n,"af")},{key:"capacity",label:"Capacity",value:n.th1_rated,text:i(n.th1_rated,n," af")},{key:"pctFull",label:"% Full",value:s,text:h}];break;case"StreamStageDischarge":case"StreamStageOnly":u="Stream";f=o.streams;const c=n.gageType==="StreamStageDischarge"?i(n.flow,n,"cfs",1):"N/A";e=[{key:"stage",label:"Stage",value:t.roundValue(n.stage),text:i(n.stage,n,"ft",1)},{key:"flow",label:"Flow",value:t.roundValue(n.flow),text:c}]}return{gageType:u,latLng:s,layerGroup:f,displayValues:e}},_isStale:function(n){const t=(new Date-n.timestampDate)/36e5;return t>=n.noReportTime},sensorListCheckboxClicked:function(){const t=this,n=$(".sensorListCbx:checked");n.length>2?n.each(function(){if(this!=t)return $(this).prop("checked",!1),!1}):n.length===2?$("#compareSensorsBtn").prop("disabled",!1):$("#compareSensorsBtn").prop("disabled",!0)},compareSensorsClicked:function(){const n=[];$(".sensorListCbx:checked").each(function(){n.push(Number(this.id.substring(valleyWaterMain._sensorListIdPrefix.length)))})},sensorListSortClicked:function(){const t=$(this),n=valleyWaterMain,i=t.data("sort");let r="fa-sort-up";i!==n._sortSensorsBy?(n._sortSensorsBy=i,n._sortSensorsAsc=!0):(n._sortSensorsAsc=!n._sortSensorsAsc,n._sortSensorsAsc||(r="fa-sort-down"));t.find("i").removeClass("fa-sort-up").removeClass("fa-sort-down").removeClass("fa-sort").addClass(r);t.siblings(".sensorListSort").find("i").addClass("fa-sort").removeClass("fa-sort-up").removeClass("fa-sort-down");const u=t.parents("table").data("type");u==="rain"?n._sensors.precipitation.sort(n._sortCompareSensors):u==="reservoir"?n._sensors.reservoirs.sort(n._sortCompareSensors):n._sensors.streams.sort(n._sortCompareSensors);n._showSensors(!1)},_sortCompareSensors:function(n,t){function h(n){switch(n.gageType){case"Precipitation":return 1;case"Reservoir":return 2;default:return 3}}function o(n,t,i){return e._isStale(n)||!i&&n.gageType==="StreamStageOnly"&&t===0?-1:t}const e=valleyWaterMain;let i,r;const u=e.getSensorValues(n),f=e.getSensorValues(t);switch(e._sortSensorsBy){case"type":i=h(n);r=h(t);break;case"number":i=n.gageId;r=t.gageId;break;case"name":i=n.name.toLowerCase();r=t.name.toLowerCase();break;case"watershed":i=n.watershed.toLowerCase();r=t.watershed.toLowerCase();break;case"update":i=n.timestampDate;r=t.timestampDate;break;case"capacity":i=n.th1_rated;r=t.th1_rated;break;case"pctFull":i=u.rating/n.th1_rated;r=f.rating/t.th1_rated;break;case"value":i=o(n,u.value,!0);r=o(t,f.value,!0);break;case"rating":i=o(n,u.rating,!1);r=o(t,f.rating,!1);break;case"hr1":i=u.hr1;r=f.hr1;break;case"hr3":i=u.hr3;r=f.hr3;break;case"hr6":i=u.hr6;r=f.hr6;break;case"hr12":i=u.hr12;r=f.hr12;break;case"hr24":i=u.hr24;r=f.hr24;break;case"ytd":i=u.ytd;r=f.ytd}let s=i<r?-1:i===r?0:1;return e._sortSensorsAsc||(s*=-1),s},floodwatchToggleChanged:function(n){const t=n.target,i=$(t).is(":checked");$(".floodwatch-toggle").each(function(){this!==t&&$(this).prop("checked",i)});valleyWaterMain._showSensors(!0)},_updateTimestampDisplay:function(n){const t=valleyWaterMain._lastUpdate,i=n?"Data updated ":"Problem obtaining data. Last update was ";if(t){const n=this._getPacificDate(t);$(".updateTimestamp").text(i+n.date+" "+n.time+" "+n.zone);$("#listHeaderUpdate").text("Update ("+n.zone+")")}},_getPacificDate:function(n){const t=this.__getPacific(n),i=t.utcOffset()/60==-8?"PST":"PDT";return{date:t.format("M/D/YYYY"),time:t.format("h:mm A"),zone:i}},_getPacificDateStart:function(n){const t=this.__getPacific(n).startOf("day");return t.toDate()},__getPacific:function(n){const t=moment.tz(n,this._timezone);return valleyWaterSettings.AdjustTimestampsForDST||t.utcOffset(-8),t},resetPopupsOffset:function(){$(".leaflet-popup").css("left",valleyWaterMain._popupOffsetPixels+"px")},windowResized:function(){const i=valleyWaterMain,r=i.isMobileWidth(),n=$("#layerModal"),t=$(".layer-sidebar");r?n.is(":visible")&&(n.hide(),t.removeClass("closed")):t.hasClass("closed")||(t.addClass("closed"),n.fadeIn("fast"))},isMobileWidth:function(){return $(window).width()<valleyWaterMain._targetWidth},roundValue:function(n,t){return isNaN(t)&&(t=1),n!==null&&n!=0?n.toFixed(t):n===null?"N/A":"0"},_getQuery:function(){const n=location.search.substring(1),t={};if(n.length>1){const i=n.split("&");for(let n,r=-1;n=i[++r];){const i=n.split("=");i.length===2&&(t[i[0]]=i[1])}}return t},_getSensor:function(n){function i(n,t){let i=null;return $.each(n,function(){if(this.gageId===t)return i=this,!1}),i}let t=i(this._sensors.precipitation,n);return t||(t=i(this._sensors.reservoirs,n)),t||(t=i(this._sensors.streams,n)),t},roundNumber:function(n,t){const i=Math.pow(10,t||0);return Math.round((n+Number.EPSILON)*i)/i},_initTour:function(){function t(n,t){!t||n<vwConfig.tour.steps.length-1?valleyWaterMain.showTourStep(n,t):valleyWaterMain._hideTourStep(n)}function i(){const t=$(".popover"),i=t.find(".tour-close").data("stepnum"),r=vwConfig.tour.steps[i],n=r.adjustMobilePosition,u=n.placement==="top"?"bottom":"top",f=n.placement==="top"?"top":"bottom";t.removeClass("bs-popover-"+u).addClass("bs-popover-"+f);t.css("transform","translate3d("+n.transformX+"px,"+n.transformY+"px, 0px)")}const n=vwConfig.tour.steps.length;$("#startTourSteps").text("1 of "+n);for(let t=0;t<n;t++){const r=vwConfig.tour.steps[t];if(r.elementSelector){const u=$(r.elementSelector),f=$(".mobile-sidebar").is(":visible");u.each(function(){const u=$(this);if(valleyWaterMain._elementHeight(u)>1){const e="<button type='button' class='close tour-close' data-dismiss='modal' data-stepnum='"+t+"' aria-label='Close'><span aria-hidden='true'>&times;<\/span><\/button>",o=t===0?"":"<button type='button' class='btn tour-prev-step-btn' data-stepnum='"+t+"'>Previous<\/button>",s=t<n-1?"Next":"Got it",h="<div><div class='floatleft tour-steps'>"+(t+1).toString()+" of "+n+"<\/p><\/div><div class='floatright'>"+o+"<button type='button' class='btn tour-next-step-btn' data-stepnum='"+t+"'>"+s+"<\/button><\/div><div class='clear'><\/div><\/div>";if(u.popover({title:r.title+e,content:r.content+h,placement:r.placement,html:!0,sanitize:!1,trigger:"manual"}),f&&r.adjustMobilePosition)u.on("shown.bs.popover",i)}})}}$("#tour-start").click(function(){$("#tour-background").show()});$(document).on("click",".tour-close",function(){const n=$(this).data("stepnum");valleyWaterMain._hideTourStep(n)});$(document).on("click",".tour-next-step-btn",function(){const n=$(this).data("stepnum");t(n,!0)});$(document).on("click",".tour-prev-step-btn",function(){const n=$(this).data("stepnum");t(n,!1)})},showTourStep:function(n,t){const i=vwConfig.tour.steps[n+(t?1:-1)],r=i.background.split(",");if(valleyWaterMain._hideTourStep(n),r.forEach(function(n){$(n).show()}),i.modalId)$(i.modalId).modal("show");else{const n=$(i.elementSelector).filter(":visible");n.popover("show")}i.addClasses&&i.addClasses.forEach(function(n){$(n[0]).addClass(n[1])})},_hideTourStep:function(n){const t=vwConfig.tour.steps[n],i=t.background.split(",");i.forEach(function(n){$(n).hide()});t.modalId?$(t.modalId).modal("hide"):$(t.elementSelector).popover("hide");t.addClasses&&t.addClasses.forEach(function(n){$(n[0]).removeClass(n[1])})},_getAppRoot:function(){let t="";const n=location.pathname;return n.length>1&&(t=n,n.lastIndexOf("/")<n.length-1&&(t+="/")),t},_elementHeight:function(n){return Math.min(n.height(),n.parent().height(),n.parent().parent().height())}};$().ready(valleyWaterMain.init);$.widget("custom.tierraplanAutocomplete",$.ui.autocomplete,{_renderItem:function(n,t){var r=$("#autocompleteSearchInput").val(),u=(r+"").replace(/([\\\.\+\*\?\[\^\]\$\(\)\{\}\=\!\<\>\|\:])/g,"\\$1"),i=t.label.replace(new RegExp("("+u+")","gi"),"<b>$1<\/b>");return i===""&&(i="(No label)"),$("<li>").attr("data-value",t.value).append($("<a>").html(i)).appendTo(n)},_renderMenu:function(n,t){var i=this;$.each(t,function(t,r){i._renderItemData(n,r)});$(n).find("li:odd").addClass("autocompleteMenuOdd")}});const valleyWaterMap={_startupBasemap:"valleywater",_countyBounds:[[37.47,-122.24],[36.89,-121.2]],_map:null,_basemaps:null,_layers:null,_layersPane:null,_sensorLayers:null,_sensorPopups:null,_currentZoomLevel:null,_savedExtent:null,_weatherLayer:null,_camerasLayer:null,_basemapLoaded:!1,_minZoomPopups:12,init:function(){this._map=L.map("mapDiv",{zoomControl:!0}).fitBounds(this._countyBounds);this._basemaps={valleywater:[L.esri.basemapLayer("GrayLabels",{name:"valleywaterLabelsBasemap"}),L.esri.basemapLayer("Gray",{name:"valleywaterBasemap"})],streets:[L.esri.basemapLayer("Streets",{name:"streetsBasemap"})],imagery:[L.esri.basemapLayer("ImageryLabels",{name:"imageryLabelsBasemap"}),L.esri.basemapLayer("ImageryTransportation",{name:"imageryTransBasemap"}),L.esri.basemapLayer("ImageryClarity",{name:"imageryBasemap"})],topo:[L.esri.basemapLayer("Topographic",{name:"topoBasemap"})]};this._basemaps.valleywater[0].on("load",function(){valleyWaterMap._basemapLoaded||(valleyWaterMap._basemapLoaded=!0,valleyWaterMap._addGeoJsonLayers(),valleyWaterMap._addCameras())});this._basemaps.valleywater[1].addTo(this._map);this._basemaps.valleywater[0].addTo(this._map);this._currentBasemaps=this._basemaps.valleywater;$("input[name='mobileBasemapRadio']").click(function(){valleyWaterMap.changeBasemap(this.value,!0)});$(".basemaps img").click(function(){valleyWaterMap.changeBasemap($(this).data("basemap"),!1)});this._createSensorLayers();this._currentZoomLevel=this._map.getZoom();this._map.on("zoomend",function(){const n=valleyWaterMap,t=n._map.getZoom();let i=!1;if(n._currentZoomLevel<n._minZoomPopups&&t>=n._minZoomPopups?i=!0:n._currentZoomLevel>=n._minZoomPopups&&t<n._minZoomPopups&&(i=!0),i){const t=valleyWaterMain.getSensorLayerVisibilities();n.updateSensorVisibilities(t)}n._currentZoomLevel=t});$("#mapDiv").on("click",".leaflet-popup",this.popupClicked);$("#mapLayers").on("click","input",this.overlayChecked);$("#mobileLayers").on("click","input",this.overlayChecked);$(".webcamsFrontBtn").on("click",this.camerasToFrontClicked);this._map.on("zoomend",valleyWaterMain.resetPopupsOffset);this._initLocation()},_userLocation:null,_initLocation:function(){function n(n){const t=valleyWaterMap,i=n.coords.latitude,r=n.coords.longitude;if(valleyWaterMap._userLocation=n,t._locationMarker)t._locationMarker.setLatLng([i,r]);else{const n=L.divIcon({html:t._locationSvg,iconSize:[50,50],className:"location"});t._locationMarker=L.marker([i,r],{icon:n}).bindTooltip("Your location").bindPopup("Your location").addTo(t._map)}}function t(n){n.code===n.PERMISSION_DENIED&&$("#locateBtn").hide()}navigator.geolocation?(navigator.geolocation.getCurrentPosition(function(i){n(i);try{navigator.geolocation.watchPosition(n,t)}catch(r){console.log("Error watching position. Geolocation will not be updated. Error:",r)}},t),$("#locateBtn").click(valleyWaterMap.locateUserOnMap)):$("#locateBtn").hide()},_locationMarker:null,_locationSvg:'<svg width="50px" height="50px" viewBox="0 0 50 50" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>Current Location<\/title><desc>Visitor current location<\/desc> <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g fill="#0060A9"><circle class="halo" fill-opacity="0.3" cx="25" cy="25" r="12"><\/circle><circle class="center" stroke="#FFFFFF" cx="25" cy="25" r="5"><\/circle><\/g><\/g><\/svg>',locateUserOnMap:function(){const n=valleyWaterMap._userLocation;if(n){const t=n.coords;valleyWaterMap._map.flyTo([t.latitude,t.longitude],15)}},resizeMap:function(){this._map.invalidateSize({debounceMoveend:!0,animate:!0})},changeBasemap:function(n,t){const i=valleyWaterMap,r=i._basemaps[n];for(let n=0;n<i._currentBasemaps.length;n++)i._map.removeLayer(i._currentBasemaps[n]);let u;for(let n=0;n<r.length;n++)u=r[n],u.addTo(i._map),u.bringToBack();i._currentBasemaps=r;t||$("#mobileBasemapLayers input[type='radio']").each(function(){this.value===n&&$(this).prop("checked",!0)});$("#layerModal img").each(function(){const t=$(this);t.data("basemap")===n?t.addClass("active"):t.removeClass("active")})},_createSensorLayers:function(){this._layers={};const n=["precipitation","reservoirs","streams"];for(let t,i=-1;t=n[++i];){const r=t+"Markers",u=t+"Popups",i=this._map.createPane(r),n=this._map.createPane(u);i.style.zIndex=650;n.style.zIndex=700;n.style.display="none";this._layers[t]={name:t,markerPane:i,popupPane:n,markers:L.layerGroup().addTo(this._map),popups:L.layerGroup().addTo(this._map)}}},clearSensors:function(){const n=valleyWaterMap._layers;n.precipitation.markers.clearLayers();n.precipitation.popups.clearLayers();n.reservoirs.markers.clearLayers();n.reservoirs.popups.clearLayers();n.streams.markers.clearLayers();n.streams.popups.clearLayers()},updateSensorVisibilities:function(n){const r=valleyWaterMap,u=r._map.getZoom(),i=u>=r._minZoomPopups,t=valleyWaterMap._layers;t.precipitation.markerPane.style.display=n.precipitationOn?"block":"none";t.precipitation.popupPane.style.display=n.precipitationOn&&i?"block":"none";t.reservoirs.markerPane.style.display=n.reservoirsOn?"block":"none";t.reservoirs.popupPane.style.display=n.reservoirsOn&&i?"block":"none";t.streams.markerPane.style.display=n.streamsOn?"block":"none";t.streams.popupPane.style.display=n.streamsOn&&i?"block":"none"},addSensor:function(n,t,i,r){const o=valleyWaterMain,u=o.getSensorDisplayInfo(n),e=u.gageType.toLowerCase(),s=L.divIcon({className:"sensor-pin "+e,html:t,iconSize:L.point(55,55)}),h=L.marker(u.latLng,{gageId:n.gageId,icon:s,pane:u.layerGroup.name+"Markers"}).addTo(u.layerGroup.markers);h.on("click",function(n){const t=n.target.options.gageId;valleyWaterSensor.showSensorPanel(t,!0)});const c=n.gageType==="Precipitation"?0:1,f=["<div class='sensor-popup-div' data-sensorid='"+n.gageId+"' title='"+i+"'>"];for(let n=0;n<u.displayValues.length;n++){const t=u.displayValues[n];f.push("<div class='sensor-popup-"+e);n!==c&&f.push(" hidden-startup");f.push(" sensor-popup-"+e+"-"+t.key+"'>");f.push(t.text+"<\/div>")}f.push("<\/div>");L.popup({autoClose:!1,closeOnClick:!1,closeOnEscapeKey:!1,offset:L.point(r,0),pane:u.layerGroup.name+"Popups"}).setLatLng(u.latLng).setContent(f.join("")).addTo(u.layerGroup.popups)},popupClicked:function(n){const i=$(n.target);let t=i.data("sensorid");t||(t=i.parent().data("sensorid"));t||(t=i.find(".sensor-popup-div").data("sensorid"));t&&valleyWaterSensor.showSensorPanel(t,!0)},saveExtent:function(){valleyWaterMap._savedExtent=valleyWaterMap._map.getBounds()},resetExtent:function(){valleyWaterMap._savedExtent&&valleyWaterMap._map.fitBounds(valleyWaterMap._savedExtent)},zoomMap:function(n,t,i){valleyWaterMap._map.flyTo([n,t],i)},weatherLayerChecked:function(n){const t=valleyWaterMap;if(n){if(!t._weatherLayer)t._weatherLayer=L.tileLayer("http://{s}.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png",{subdomains:["mesonet","mesonet1","mesonet2","mesonet3"]});t._weatherLayer.addTo(t._map)}else t._weatherLayer.remove()},_addGeoJsonLayers:function(){function i(){if(t===n.length){const i=[],r=[],f=valleyWaterMap,u=f._map.createPane("topPane");u.style.zIndex=800;const e=location.search.indexOf("labels")>0;let t=!0;$.each(n,function(n){if(this.data){const o=this.tooltipClass;this.layer=L.geoJSON(this.data,{style:this.style,onEachFeature:function(n,t){e?t.bindTooltip(function(n){return n.feature.properties.NAME},{permanent:!0,direction:"center",className:o}):t.bindTooltip(function(n){return n.feature.properties.NAME+" Watershed"},{sticky:!0,pane:u})}});const s="geojson_"+this.name,h="geojson_"+this.name+"_mobile";let f="<div class='layer";t&&(f+=" alt");f+="'><div class='form-check checkbox d-flex align-items-center justify-content-start'><input class='form-check-input' type='checkbox' id='{lyrId}' data-gjlyr='"+n+"'><label class='form-check-label' for='{lyrId}'><span>"+this.title+"<\/span><\/label><\/div><\/div>";i.push(f.replace(/{lyrId}/g,s));r.push(f.replace(/{lyrId}/g,h));t=!t}});$("#mapLayers").append(i.join(""));$("#mobileLayers").append(r.join(""))}}const n=vwConfig.geoJsonLayers;let t=0;$.each(n,function(r){$.ajax({url:"geojson/"+this.filename,lyrIdx:r}).done(function(r){n[this.lyrIdx].data=r;t++;i()}).fail(function(n){console.log("Could not retrieve GeoJSON layer file!",n);t++;i()})})},overlayChecked:function(){const i=$(this).data("gjlyr"),t=valleyWaterMap,n=$(this).is(":checked");if(i>=0){const r=vwConfig.geoJsonLayers[i].layer;n?r.addTo(t._map):r.remove()}else $(this).parent().hasClass("cameraCbx")?t.camerasLayerChecked(n):t.weatherLayerChecked(n);const r=this.id.indexOf("_mobile");let u;u=r>0?this.id.substring(0,r):this.id+"_mobile";$("#"+u).prop("checked",n)},_addCameras:function(){const t=vwConfig.camerasLayer,i=valleyWaterSettings.ValleyWaterApiUrl+"/"+t.dataUrl,n=valleyWaterMap;$.getJSON(i,function(i){const f=L.icon({iconUrl:valleyWaterMain._getAppRoot()+t.symbol.iconUrl,iconSize:t.symbol.iconSize}),r=[];n._camerasPane=n._map.createPane("camerasPane");n._camerasPane.style.zIndex=600;n._camerasTooltipPane=n._map.createPane("cameraTooltips");n._camerasTooltipPane.style.zIndex=850;for(let u=0;u<i.length;u++){const e=i[u];r.push(L.marker([e.latitude,e.longitude],{icon:f,cameraId:e.cameraId,pane:n._camerasPane}).bindTooltip(e.name+" (Webcam "+e.cameraId+")<br>Click to open webcam",{pane:n._camerasTooltipPane}).on("click",function(n){const i=n.target.options.cameraId;window.open(t.webcamsUrl+i,"_blank")}))}n._camerasLayer=L.featureGroup(r).addTo(n._map);let u="<div class='layer'><div class='form-check checkbox d-flex align-items-center justify-content-start cameraCbx'><input class='form-check-input' type='checkbox' id='{lyrId}' checked='checked'><label class='form-check-label' for='{lyrId}'><span>Webcams<\/span><\/label><\/div><\/div>";const e=u.replace(/{lyrId}/g,"cameras"),o=u.replace(/{lyrId}/g,"cameras_mobile");$("#mapLayers").append(e);$("#mobileLayers").append(o)}).fail(function(n,t,i){console.log("Error getting cameras data: "+i);console.log(n)})},camerasLayerChecked:function(n){n?this._camerasLayer.addTo(this._map):this._camerasLayer.remove()},camerasToFrontClicked:function(n){const t=$(n.target).is(":checked"),i=t?800:600;valleyWaterMap._camerasPane.style.zIndex=i;const r=this.id.indexOf("Mobile")>0?"Desktop":"Mobile";$("#webcamsFrontBtn"+r).prop("checked",t)}},valleyWaterSensor={_zoomToSensorLevel:14,_chartLineValueColor:"#7cb5ec",_chartLineRatingColor:"#333333",_hoursActualDataInForecastChart:24,_sensorTimeoutSeconds:30,_currentSensor:null,_currentData:null,_currentForecastData:null,_currentDayData:null,_chart:null,_forecastChart:null,_usgsUrl:"https://waterdata.usgs.gov/monitoring-location/",_newSensorSet:!1,_dateChangedFlag:!1,init:function(){function n(n){const t=new Date;return n&&t.setDate(t.getDate()-n),t.toLocaleDateString()}$("#sensorBackBtn").click(this.sensorBackClicked);$("#sensorViewMapBtn").click(this.sensorToMapClicked);$("#chartContainer").on("change",".highcharts-legend-checkbox",function(){valleyWaterSensor.seriesCheckboxChanged(this,!1)});$("#forecastChartContainer").on("change",".highcharts-legend-checkbox",function(){valleyWaterSensor.seriesCheckboxChanged(this,!0)});$("#mainThresholdToggle").change(this._updateChart);$("#forecastThresholdToggle").change(this.updateForecastChart);$(".sensorExportMenu").click(function(){$(this).children("div").slideToggle()});$("#sensorTableExportDropdown > div").click(this.sensorTableExportClicked);$(".sensorExportHighcharts").click(this.sensorExportHighcharts);Highcharts.setOptions({color:["#7cb5ec","#333333","#333333"]});const t=n(7),i=n(0);$(".sensorStartDate").val(t);$(".sensorEndDate").val(i);$(".sensorDate").on("change",function(n){const i=n.target.parentElement.id,t=new Date(n.target.value);if(t instanceof Date&&!isNaN(t)){const n=i.indexOf("Graph")>0?"Graph":"Table",r=i.indexOf("Start")>0?"Start":"End";valleyWaterSensor._updateDatepicker("#sensor"+n+r+"Date",t)}});$(".input-group.date").datepicker({todayHighlight:!0,autoclose:!0}).on("show",function(){const n=$(".datepicker"),t=n.position().top;n.css("top",(t+110).toString()+"px")}).on("changeDate",function(n){const t=valleyWaterSensor;if(t._dateChangedFlag)t._dateChangedFlag=!1;else{t._newSensorSet=!1;t._dateChangedFlag=!0;const i=n.target.id,r=i.indexOf("Graph")>0?"Table":"Graph",u=i.indexOf("Start")>0?"Start":"End";t._updateDatepicker("#sensor"+r+u+"Date",n.date);t.getSensorData()}})},showSensorPanel:function(n,t){const r=valleyWaterSensor,i=valleyWaterMain._getSensor(n);if(i){let u="Back to list",f="block";t&&(u="Back to map",f="none");$("#sensorBackBtn > span").text(u);$("#sensorViewMapBtn").css("display",f);const s=r._getSensorTitle(i);$("#sensorPanelTitle").html(s);r._currentSensor=i;valleyWaterMain.switchMainSensorPanels(!0);valleyWaterMain.setBrowserHistory("?p=sensor&sid="+n,{panel:"sensor",sid:n});r._createSensorInfo(i);r._newSensorSet=!0;r.getSensorData();const e=$("#forecasts-tab").parent(),o=$(".sensor-threshold");i.hasForecast?(e.show(),r._getForecastData()):(e.hide(),$("#graph-tab").click());const h=i.th1_direct>0||i.th1_rates>0||i.th2_direct>0||i.th2_rated>0||i.th3_direct>0||i.th3_rated>0||i.th4_direct>0||i.th4_rated>0;h?o.show():o.hide()}},sensorBackClicked:function(){const n=$(this).text().indexOf("Back to map")>0;valleyWaterMain.switchMainSensorPanels(!1,n)},sensorToMapClicked:function(){const n=valleyWaterSensor._currentSensor;valleyWaterMain.switchMainSensorPanels(!1,!0);valleyWaterMap.zoomMap(n.latitude,n.longitude,valleyWaterSensor._zoomToSensorLevel)},_updateDatepicker:function(n,t){$(n).datepicker("setDate",t)},getSensorData:function(){$(".sensor-table").hide();$("#chartContainer").hide();$(".sensorErrMsg").hide();$(".usgsInfoLinkDiv").hide();$(".thresholdDescriptions").hide();$(".thresholdBar").hide();$(".summaryInfo").hide();const n=this._getStartEndDates();this._setExportLinks(n);const t=new Date;if(t.setDate(t.getDate()+1),n.startDate>t||n.endDate>t||n.startDate>n.endDate){this._showApiErrorMsg("badDates");return}const r=n.endDate.getTime()-n.startDate.getTime(),i=r/864e5;if(this._currentSensor.usgsId)$(".usgsInfoLinkDiv").show(),i<=90?($(".retrievingDataDiv").show(),$(".usgsInfoLink").prop("href",this._usgsUrl+this._currentSensor.usgsId),this._getUsgsData(n)):this._showUsgsErrorMsg(!1);else if(i<valleyWaterSettings.ApiRequestMaxDays){this._setExportLinks(n);$(".retrievingDataDiv").show();const t="/sensorData/"+this._currentSensor.gageId+"/range/"+n.start+"/"+n.end+"?includeRating=true&skipZeroValues=true";$.ajax({url:valleyWaterSettings.ValleyWaterApiUrl+t,dataType:"json",timeout:this._sensorTimeoutSeconds*1e3}).done(function(n){const t=valleyWaterSensor,i=t._getStartEndDates();n.data=t._filterByPacificDates(n.data,i.start,i.end);t._currentData=n;t._updateSensorDisplay()}).fail(function(n,t,i){$(".retrievingDataDiv").hide();t==="timeout"?self._showApiErrorMsg("timeout"):(self._showApiErrorMsg("dataError"),console.log("Error getting data",i));console.log(n)})}else this._showApiErrorMsg("dateRange")},updateForecastChart:function(){const n=valleyWaterSensor,t=n._currentForecastData;t&&t!=="ERROR"&&t[0].id===n._currentSensor.gageId?n._displayForecast():valleyWaterSensor._getForecastData()},_getForecastData:function(){function r(){if(!n._currentData||!n._currentData.metadata||n._currentData.metadata.id!==t){setTimeout(r,100);return}const i=new Date,f=new Date,u=n._currentData.data,e=u[u.length-1].timeUtc,o=u[0].timeUtc;if(i.setHours(i.getHours()-2),f.setHours(i.getHours()-n._hoursActualDataInForecastChart),n._currentDayData=null,i<=e&&f>=o){const t=[];for(let n=0;n<u.length;n++){const i=u[n];i.timeUtc>=f&&t.push(i)}$(".forecastBusyDiv").hide();n._currentDayData=t;n._displayForecast()}else{const t=n._dateToYMD(f),r=n._dateToYMD(i),u=valleyWaterSettings.ValleyWaterApiUrl+"/sensorData/"+n._currentSensor.gageId+"/range/"+t+"/"+r+"?includeRating=true&skipZeroValues=true";$.getJSON(u,function(t){$(".forecastBusyDiv").hide();n._currentDayData=t.data;n._displayForecast()}).fail(function(t){console.log(t);n._displayForecast()})}}$(".forecastBusyDiv").show();$(".forecastMsg").hide();$("#forecastChartContainer").hide();const u=valleyWaterSettings.ValleyWaterApiUrl,t=this._currentSensor.gageId;let i=null,n=valleyWaterSensor;$.getJSON(u+"/sensorData/forecast/"+t,function(u){u.errorMessage.length===0&&u.forecasts.length>0?(i=u.forecasts,n._currentForecastData=i):(console.log("Problem getting forecast for "+t,u),i="ERROR",n._currentForecastData=null);r()}).fail(function(u){console.log("Error getting forecast for "+t,u);i="ERROR";n._currentForecastData=null;r()})},_dateToYMD:function(n){let i=n.getMonth()+1,r=i<10?"0"+i.toString():i.toString(),t=n.getDate().toString();return t.length<2&&(t="0"+t),n.getFullYear()+"-"+r+"-"+t},_displayForecast:function(){const n=valleyWaterSensor,t=n._currentForecastData,i=n._currentDayData;if(t&&t!=="ERROR"){const y=$("#forecastThresholdToggle").is(":checked"),r=n._currentSensor,u=n._createForecastSeries(r,t,!1),p=t[0].timestamp,w=t[t.length-1].timestamp;let f=u._min,e=u._max,l=[];if(y){const t=n._getMinMaxWithThresholds(r,!0,u._min,u._max);f=t.min;e=t.max;l=n._createThresholdPlotBands(r,!0)}else $("#forecastThresholdBar").hide();const o=n._createForecastSeries(r,t,!0);let h=null;const a=[];if(i){const n=r.gageType!=="Reservoir",u=n?"Actual Flow (cfs)":"Actual Storage (af)",o=n?" cfs":" ft";let t;for(let r=0;r<i.length;r++){const u=i[r],o=n?u.rating:Math.round(u.rating);!isNaN(o)&&(r<i.length-1||o>0)&&(f=Math.min(f,o),e=Math.max(e,o),t=u.timeUtc?u.timeUtc:new Date(u.timestamp),a.push([t.getTime(),o]))}h={name:u,data:a,type:"spline",color:"#000000",tooltip:{valueSuffix:o},yAxis:0}}const b=r.gageType==="Reservoir"?"Storage (af)":"Flow (cfs)",k={title:{text:b},reversed:!1,min:f,max:e,plotBands:l},s=[u],c=[k];if(h&&s.push(h),o){const n=Math.max(o._max,.2),t={title:{text:o.name},reversed:!0,min:0,max:n,opposite:!0};s.push(o);c.push(t)}const d=moment.tz(p,valleyWaterMain._timezone).toDate().getTime(),g=moment.tz(w,valleyWaterMain._timezone).toDate().getTime(),nt=(new Date).getTime(),v={type:"datetime",min:d,max:g,dateTimeLabelFormats:{day:"%b %e",hour:"%l %P"},plotLines:[{color:"#cc3333",width:2,value:nt,label:{text:"Current time",rotation:90,style:{color:"#cc3333",fontWeight:"bold",fontSize:"16px"}}}]};if($("#forecastChartContainer").css("display","inline-block"),n._forecastChart)n._forecastChart.update({series:s,xAxis:v,yAxis:c,title:{text:""}},!0,!0);else{Highcharts.setOptions({time:{timezone:valleyWaterMain._timezone}});const t=n._createChartOptions();t.chart.events={redraw:function(){n._updateThresholdBar(!0,!0)}};t.xAxis=v;t.yAxis=c;t.series=s;n._forecastChart=Highcharts.chart("forecastChartContainer",t);n._updateThresholdBar(!0,!0)}}else $(".forecastMsg").text("Sorry, we had a problem retrieving the forecast.").show()},_getUsgsData:function(n){function t(n,t){const i=[];return $.each(n,function(){const n={timestamp:this.dateTime,timeUtc:new Date(this.dateTime)},r=Number(this.value);t?n.value=r:n.rating=r;i.push(n)}),i}function r(n,t){const u=t.data;let r=0,f,i=u[r];$.each(n,function(n,t){if(f=new Date(t.dateTime),i.timeUtc<f)while(i.timeUtc<f)if(r++,u.length>r)i=u[r];else{i=null;break}i&&(i.rating=Number(t.value))})}const i=valleyWaterSettings.UsgsWaterApiUrl+"/iv/?format=json&siteStatus=all&sites="+this._currentSensor.usgsId+"&startDT="+n.start+"&endDT="+n.end;$.getJSON(i,function(n){const o=n.value.timeSeries,i={columns:{timestamp:"Date and Time (Pacific)",value:"Stage (ft)",rating:"Rated (cfs)"},data:[]};let u=null,f=null;$.each(o,function(n,t){const i=t.variable.variableCode[0].value,r=t.values[0].value;i==="00060"?u=r:i==="00065"&&(f=r)});f?(i.data=t(f,!0),u&&r(u,i)):i.data=t(u,!1);const e=valleyWaterSensor;i.metadata={id:e._currentSensor.gageId};e._currentData=i;e._updateSensorDisplay()}).fail(function(n,t,i){$(".retrievingDataDiv").hide();valleyWaterSensor._showUsgsErrorMsg(!0);t==="timeout"?console.log("USGS request timeout",i):console.log("Error getting USGS data",i);console.log(n)})},_filterByPacificDates:function(n,t,i){const u=moment.tz(t+"T00:00:00",valleyWaterMain._timezone),f=moment.tz(i+"T23:59:59",valleyWaterMain._timezone),r=[];return $.each(n,function(n,t){t.timestamp.indexOf("-",12)<0&&(t.timestamp+="Z");t.timeUtc=new Date(t.timestamp);const i=moment(t.timeUtc);i.isSameOrAfter(u)&&i.isSameOrBefore(f)&&r.push(t)}),r},_getStartEndDates:function(){const n=$("#sensorGraphEndDate").datepicker("getDate"),t=valleyWaterSensor,i=$("#sensorGraphStartDate").datepicker("getDate");return{start:t._dateToYMD(i),end:t._dateToYMD(n),startDate:i,endDate:n}},_updateSensorDisplay:function(){$(".retrievingDataDiv").hide();this._currentData&&this._currentData.data.length>0?($(".processingDataDiv").show(),this._updateChart(),this._updateTable(),this._updateThresholdDescriptions(),$(".processingDataDiv").hide()):this._showNoDataMsg();this._updateSummary()},_updateSummary:function(){const n=this._currentSensor,t=$(".summaryInfo");if(n.gageType==="Precipitation"&&n.precipYtd>0){let i=0;for(let n=0;n<this._currentData.data.length;n++)i+=this._currentData.data[n].value;let r="";i>0&&(r="Precipitation within selected date range: "+i.toFixed(2)+" in.<br/>");t.html(r+"Precipitation year to date (since Oct 1): "+n.precipYtd.toFixed(2)+" in.").show()}else t.hide()},_updateTable:function(){const i=valleyWaterMain._getPacificDate(this._currentData.data[0]),n=["<thead><tr>"];n.push("<th>Updated ("+i.zone+")<\/th>");n.push("<th>");n.push(this._currentData.columns.value);n.push("<\/th>");let t=!1;this._currentData.columns.rating&&(t=!0,n.push("<th>"),n.push(this._currentData.columns.rating),n.push("<\/th>"));n.push("<\/tr><\/thead><tbody>");for(let i=this._currentData.data.length-1;i>=0;i--){const r=this._currentData.data[i];n.push("<tr><td>");const u=valleyWaterMain._getPacificDate(r.timeUtc);n.push(u.date+" "+u.time);n.push("<\/td><td>");n.push(valleyWaterMain.roundNumber(r.value,2));n.push("<\/td>");n.push("<td>");t&&typeof r.rating!="undefined"&&r.rating!==null&&n.push(valleyWaterMain.roundNumber(r.rating,2));n.push("<\/td>");n.push("<\/tr>")}n.push("<\/tbody>");$(".sensor-table").html(n.join("")).show()},_updateChart:function(){const n=valleyWaterSensor,i=n._currentSensor,t=n._createSeriesData(i,n._currentData,!1),a=n._currentSensor.gageType==="Precipitation",f=!a&&$("#mainThresholdToggle").is(":checked");let e=t._min,o=t._max,s=[];if(f){const r=n._getMinMaxWithThresholds(i,!1,t._min,t._max);e=r.min;o=r.max;s=n._createThresholdPlotBands(i,!1);t.visible=!0}else $("#thresholdBar").hide();const v={title:{text:t.name},reversed:t._reversed,min:e,max:o,plotBands:s},u=[v],r=[t];if(!f&&(i.gageType==="Reservoir"||i.gageType==="StreamStageDischarge")){const t=n._createSeriesData(i,n._currentData,!0);let f=t._min,e=t._max;t.yAxis=1;r.push(t);const o={title:{text:t.name},reversed:t._reversed,min:f,max:e,opposite:!0};u.push(o)}const h=n._getStartEndDates(),y=moment.tz(h.start,valleyWaterMain._timezone).toDate().getTime(),p=moment.tz(h.end,valleyWaterMain._timezone).toDate(),w=p.setHours(23,59,59),c={type:"datetime",min:y,max:w,dateTimeLabelFormats:{day:"%b %e",hour:"%l %P"}};$("#chartContainer").css("display","inline-block");const l="";if(n._chart){if(!n._newSensorSet){let n=0;$("#chartContainer").find(".highcharts-legend-checkbox").each(function(){r[n].selected=this.checked;n++})}n._chart.update({series:r,xAxis:c,yAxis:u,title:{text:l}},!0,!0)}else{Highcharts.setOptions({time:{timezoneOffset:480}});const t=n._createChartOptions();t.chart.events={redraw:function(){n._updateThresholdBar(!1,!1)}};t.xAxis=c;t.yAxis=u;t.series=r;t.title.text=l;n._chart=Highcharts.chart("chartContainer",t)}},_getMinMaxWithThresholds:function(n,t,i,r){let f=i,u=r;return $.each(vwConfig.thresholdLevels,function(){const r=t?this.rating:this.value,i=n[r];i&&i>0&&(i<f&&(f=i),i>u&&(u=i))}),u>r&&(u+=(u-f)/3),f=Math.floor(f),u=Math.ceil(u),{min:f,max:u}},_createThresholdPlotBands:function(n,t){let i=[];return $.each(vwConfig.thresholdLevels,function(r){const u=t?n[this.rating]:n[this.value];if(u&&u>0){let o=1e6,f,e;for(let i=r+1;i<vwConfig.thresholdLevels.length;i++)if(e=vwConfig.thresholdLevels[i],f=t?e.rating:e.value,n[f]&&n[f]>0){o=n[f];break}i.push({from:u,to:o,color:this.graphColor})}}),i},_updateThresholdBar:function(n,t){const i=valleyWaterSensor;let r="mainThresholdToggle",u="thresholdBar",f=i._chart;if(n&&(r="forecastThresholdToggle",u="forecastThresholdBar",f=i._forecastChart),$("#"+r).is(":checked")){const h=f.yAxis[0],c=h.min,l=h.max,a=l-c,r=$("#"+u),v=r.find(".progress-bar-vertical").height(),e=r.find(".progress-bar"),n=i._currentSensor,o=vwConfig.thresholdLevels;let s=!1;$.each(o,function(i){const r=t?n[this.rating]:n[this.value];if(r&&r>0){s||(e.first().height((r-c)/a*v),s=!0);let h=l,u,f;for(let r=i+1;r<o.length;r++)if(f=o[r],u=t?f.rating:f.value,n[u]&&n[u]>0){h=n[u];break}e.eq(i+1).height((h-r)/a*v).attr("aria-valuetext",this.text)}else e.eq(i+1).height(0)});s?r.show():r.hide()}},_updateThresholdDescriptions:function(){function i(n,t,i,r){return!isNaN(n)&&!isNaN(t)&&n<t?(r.push(i),!0):!1}function t(n,t,i){let r="<div class='container info-container'><div class='row'><div class='threshold-index first'><div class='progress-bar-vertical'><div class='progress-bar full "+n+"' role='progressbar' style='height:100%' aria-valuetext='"+t+"'><\/div><\/div><\/div><div class='threshold-description'><h3>"+t+"<\/h3>";return i&&i.length>0&&(r+="<p>"+i+"<\/p>"),r+"<\/div><\/div><\/div>"}const n=this._currentSensor;if(n.gageType!=="Precipitation"){const r=[],e=n.gageType==="Reservoir"?" acre-feet":" cfs";let u=null,f=!1;if(n.highWater){const i=n.highWater+" Feet - Recent High Water";u=t("blue",i,n.highWaterDesc)}$.each(vwConfig.thresholdLevels,function(){const o=n[this.value];if(o&&o>0){f||(f=i(n.highWater,n[this.value],u,r));let o="";const s=n[this.rating];s&&s>0&&(o="("+n[this.rating].toLocaleString()+e+") ");const h=n[this.value]+" Feet "+o+"- "+this.text,c=t(this.color,h,n[this.desc]);r.push(c)}});u&&!f&&r.push(u);r.length>0&&r.unshift("<h3>Information<\/h3>");$("#thresholdDescriptions").show();const o=r.join("");$(".thresholdDescriptions").html(o)}else $(".thresholdDescriptions").hide()},_createChartOptions:function(){return{chart:{type:"line",zoomType:"x",panning:!0,panKey:"ctrl",alignTicks:!0},exporting:{enabled:!1},plotOptions:{series:{marker:{enabled:!1},tooltip:{dateTimeLabelFormats:{day:"%b %e",hour:"%l:%M %P"}},showCheckbox:!0,selected:!0,events:{legendItemClick:function(){return this.checkbox.click(),!1}}}},title:{text:""},tooltip:{dateTimeLabelFormats:{day:"%b %e",hour:"%l:%M %P"}}}},_getSensorTitle:function(n){let t=n.gageType;return n.gageType.indexOf("Stream")===0&&(t="Stream"),n.name+" ("+t+" Sensor "+n.gageId+")"},seriesCheckboxChanged:function(n,t){const i=$(n).parent().find("input"),r=t?valleyWaterSensor._forecastChart:valleyWaterSensor._chart;i.each(function(t){if(this===n){const n=r.legend.allItems[t];this.checked?n.show():n.hide()}})},_createSeriesData:function(n,t,i){let e=n.gageType,o,s,h,r=1e5,f=0;switch(n.gageType){case"StreamStageDischarge":case"StreamStageOnly":e="Stream";s="spline";o=i?"Flow (cfs)":"Stage (ft)";h=i?" cfs":" ft";break;case"Precipitation":s="column";o="Rainfall (in)";h=" in";break;case"Reservoir":s="spline";o=i?"Storage (af)":"Stage (ft)";h=i?" af":" ft"}let u,c=[];for(let n,o=-1;n=t.data[++o];){switch(e){case"Stream":case"Reservoir":u=i?n.rating:n.value;break;case"Precipitation":u=n.value}if(!isNaN(u)){r=Math.min(r,u);f=Math.max(f,u);const t=new Date(n.timeUtc.getTime());c.push([t.getTime(),u])}}const l=(f-r)/2;f+=l;switch(e){case"Stream":case"Reservoir":r-=l;break;case"Precipitation":r=0}return seriesData={name:o,data:c,type:s,color:i?this._chartLineRatingColor:this._chartLineValueColor,tooltip:{valueSuffix:h},_reversed:!1,_min:r,_max:f,_sensorType:e}},_createSensorInfo:function(n){let t="<div class='container'><div class='row'><div class='col-12'><h3>Notes<\/h3><\/div><\/div><div class='row'><div class='col-8'><p>"+n.notes+"<\/p><\/div><div class='col-4'><p><\/p><\/div><\/div ><\/div ><div class='container'><div class='row'><div class='col-12'><h3>Images<\/h3><\/div><\/div><div class='row'><div class='col-6'>";n.photo1?(t+="<img class='sensorphoto' src='sensorphotos/"+n.photo1+"' alt='"+n.photo1+"'/><\/div>",n.photo2&&(t+="<div class='col-6'><img class='sensorphoto' src='sensorphotos/"+n.photo2+"' alt='"+n.photo1+"'/><\/div>")):t+="No images available.<\/div>";t+="<\/div><\/div>";$("#sensor-info").html(t)},_createForecastSeries:function(n,t,i){let f,e,s="spline",h="#ff33ff",c="Dash",l=!1,r=1e5,u=0,a=[],y=i?"Precipitation":n.gageType;switch(y){case"StreamStageDischarge":case"StreamStageOnly":f="Forecast Flow (cfs)";e=" cfs";break;case"Reservoir":f="Forecast Storage (af)";e=" af";break;case"Precipitation":f="Forecast Rainfall (in)";h="blue";c="Solid";e=" in";s="column";l=!0}for(let n=0,f=t.length;n<f;n++){const e=t[n],f=i?e.precipitation:e.value,o=Date.parse(e.timestamp);isNaN(f)||(r=Math.min(r,f),u=Math.max(u,f),a.push([o,Number(f.toFixed(3))]))}const v=(u-r)/2;u+=v;i?r=0:(r-=v,r=Math.max(r,0));let o=n.gageType;return(o==="StreamStageDischarge"||o==="StreamStageOnly")&&(o="Stream"),{name:f,data:a,type:s,color:h,dashStyle:c,tooltip:{valueSuffix:e},yAxis:i?1:0,_reversed:l,_min:r,_max:u,_sensorType:o}},sensorExportHighcharts:function(){const t=$(this).data("export_type"),n=valleyWaterSensor,i=n._currentSensor,r=n._getSensorTitle(i);if(n._chart.update({title:{text:r}}),t!=="print"){const u=n._getStartEndDates();let r;switch(t){case"pdf":r="application/pdf";break;case"jpeg":r="image/jpeg";break;case"png":r="image/png"}n._chart.exportChartLocal({type:r,filename:"ValleyWater_"+i.gageId+"_"+u.start+"_"+u.end})}else n._chart.print();setTimeout(function(){valleyWaterSensor._chart.update({title:{text:""}},!0,!0)},500)},sensorTableExportClicked:function(){const n=$(this).data("export_type");if(n==="csv"){const t=["Date-Time,Stage (ft),Flow (cfs)"],i=valleyWaterSensor._currentData.data;let n;for(let r=0,u=i.length;r<u;r++)n=i[r],t.push("\r\n"+n.timestamp+","+n.value+","+n.rating);const r=new Blob(t,{type:"application/csv;charset=utf8"});saveAs(r,"ValleyWater_Sensor-"+valleyWaterSensor._currentData.metadata.id+".csv")}},_setExportLinks:function(n){const t=valleyWaterSettings.ValleyWaterApiUrl+"/download.html?ids="+this._currentSensor.gageId+"&start="+n.start+"&end="+n.end;$(".sensorExportCsv").prop("href",t+"&format=csv");$(".sensorExportJson").prop("href",t+"&format=json")},_showApiErrorMsg:function(n){let t;switch(n){case"timeout":t="We couldn't get the data in timely fashion, probably because of the extended date range. You may use the ";break;case"badDates":t="Start must be before end date, and dates must not be in the future. Please check dates and try again.";break;case"dateRange":t="The date range exceeds the capacity of this website. Please narrow the date range, or use the ";break;case"dataError":t="Sorry, we had a problem retrieving the data. Try again, or consider downloading the data from the ";break;default:t=n}$(".apiErrorInfo").text(t);$(".apiErrorMsg").show()},_showUsgsErrorMsg:function(n){const t=n?"Sorry, the USGS server returned an error, or is not responding in a timely fashion. Try again later.":"The date range exceeds the limit set by the USGS. Please reduce the date range, or visit the USGS to obtain data.";$(".usgsErrorMsg").text(t).show()},_showNoDataMsg:function(){$(".noDataReturnedMsg").show()}};